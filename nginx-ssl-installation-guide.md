# NginX v1.7+ SSL 인증서 설치 가이드

> 본 문서는 한국정보인증(KICA) SSL 인증서 설치 가이드를 참고하여 작성되었습니다.

## 목차

1. [설치 전 준비사항](#1-설치-전-준비사항)
2. [SSL 인증서 설치](#2-ssl-인증서-설치)
3. [SSL 인증서 설치 확인](#3-ssl-인증서-설치-확인)
4. [주의사항 및 자주 발생하는 오류](#4-주의사항-및-자주-발생하는-오류)

---

## 1. 설치 전 준비사항

### 1.1 SSL 인증서 파일 준비

발급된 인증서는 메일로 발송되며, NginX용 인증서 파일은 **총 2개**가 제공됩니다:

| 파일 종류 | 파일명 예시 | 설명 |
|---------|-----------|------|
| 도메인 인증서 | `도메인_NginX_cert.pem` | 도메인 인증서 + 중개/루트인증서 포함 |
| 복호화된 개인키 | `도메인_NginX_nopass_key.pem` | 패스워드가 없는 개인키 파일 |

**인증서 파일 구조** (`도메인_NginX_cert.pem`):
```
-----BEGIN CERTIFICATE-----
도메인 인증서
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
중개인증서2
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
중개인증서1
-----END CERTIFICATE-----
-----BEGIN CERTIFICATE-----
루트인증서
-----END CERTIFICATE-----
```

### 1.2 인증서 타입별 주의사항

| 상품 종류 | 차이점 |
|---------|-------|
| **싱글 도메인** | 한 서버에 복수로 인증서 설치 시 단일 도메인 인증서는 **포트 공유 불가능**. Apache 2.2.12 버전 이상부터는 SNI 기능을 이용하여 포트 공유 가능 |
| **멀티 도메인** | 멀티 인증서에 등록된 도메인은 **포트 공유 가능**. NameVirtualHost 설정을 추가하고, `<Virtual Host> ~ </Virtual Host>` 구문을 설치할 도메인 수량에 맞추어 설정 |
| **와일드카드 도메인** | 와일드카드 인증서는 모든 서브도메인을 사용할 수 있고, **포트 공유 가능**. NameVirtualHost 설정을 추가하고, `<Virtual Host>~</Virtual Host>` 구문을 도메인에 따라 추가 |

---

## 2. SSL 인증서 설치

### 2.1 nginx.conf 파일 수정

`nginx.conf` 파일 위치: 일반적으로 `NginX홈/conf/` 하위에 위치 (해당 위치에 없을 경우, 내부적으로 위치 확인 필요)

```nginx
server {
    listen 443;                          # SSL 포트 설정 (기본값: 443)
    server_name 도메인;                   # 도메인명 입력

    ssl on;
    ssl_certificate      /경로/도메인_NginX_cert.pem;         # 도메인 인증서 경로
    ssl_certificate_key  /경로/도메인_NginX_nopass_key.pem;   # 개인키 경로

    ssl_session_cache    shared:SSL:1m;
    ssl_session_timeout  5m;
    ssl_protocols        TLSv1.2;                             # SSL 프로토콜 설정
    ssl_ciphers          ALL:+HIGH:+MEDIUM:!SSLv2:!PSK:!SRP:!ADH:!AECDH:!EXP:!RC4:+SHA;  # Cipher Suites 설정
    ssl_prefer_server_ciphers on;

    location / {
        root html;
        index index.html index.htm;
    }
}
```

**주요 설정 항목:**

| 설정 항목 | 설명 |
|---------|------|
| `listen 443` | SSL 사용 포트 설정 (기본값: 443). 다른 포트로 변경 가능하며, 방화벽 차단 여부 확인 필요 |
| `server_name` | SSL 인증서가 적용될 도메인명 |
| `ssl_certificate` | 도메인 인증서 파일의 전체 경로 |
| `ssl_certificate_key` | 복호화된 개인키 파일의 전체 경로 |
| `ssl_protocols` | 사용할 SSL/TLS 프로토콜 버전 (TLSv1.2 이상 권장) |
| `ssl_ciphers` | 사용할 암호화 알고리즘 |

### 2.2 NginX 웹서버 재기동

설정 변경 후 서비스 재시작:

```bash
# Linux/Unix
[root@localhost bin]$ ./nginx restart

# 또는 systemctl 사용
sudo systemctl restart nginx

# 또는 service 명령어 사용
sudo service nginx restart
```

> **주의**: 재기동시 오류가 발생한다면 SSL 오류 로그 또는 오류 로그 확인 필요

---

## 3. SSL 인증서 설치 확인

### 3.1 서버에서 확인하는 방법

**SSL 포트 확인:**
```bash
[root@localhost bin]# netstat -nap | grep 443
tcp    0    0.0.0.0:443    0.0.0.0:*    LISTEN
```

**OpenSSL 명령어로 인증서 적용 여부 확인:**
```bash
# 인증서 유효기간 확인
openssl s_client -connect 도메인:포트 | openssl x509 -noout -dates

# 예시
[root@localhost bin]# openssl s_client -connect www.example.com:443 | openssl x509 -noout -dates
---
#발급받은 인증서 유효기간 확인
notBefore=May 11 00:00:00 2021 GMT
notAfter=Jun 12 23:59:59 2022 GMT
```

**인증서 상세 정보 확인:**
```bash
openssl s_client -connect 도메인:포트
```

확인해야 할 총 4개 인증서 정보:
1. 도메인 인증서 (CN = 발급도메인)
2. 중개인증서 1 (CN = Sectigo RSA ~)
3. 중개인증서 2 (CN = Usertrust~)
4. 루트인증서 (CN = AAA~)

### 3.2 브라우저에서 확인하는 방법

1. `https://도메인:포트` 로 접속
2. 브라우저 주소창의 자물쇠 아이콘 클릭
3. "이 사이트는 보안 연결(HTTPS)이 사용되었습니다" 확인
4. "인증서가 유효함" 클릭하여 상세 정보 확인

**Chrome 브라우저 확인 절차:**
- 자물쇠 아이콘 클릭 > 보안 > 인증서가 유효함 > 인증서 정보 확인

---

## 4. 주의사항 및 자주 발생하는 오류

### 4.1 주의사항

#### Web-WAS 연동일 경우, 인증서 설치 위치
- 인증서는 WEB 혹은 WAS 둘중에 원하시는 프로세스에 설치
- 보통의 경우 WEB에 설치를 진행하며 80포트를 이용하는 웹서버에 주로 설치

#### 인증서와 개인키 keypair(키쌍)이 안 맞으면 인증서가 정상 로드되지 않음
- 발급 신청 시, 생성된 CSR과 매칭되는 개인키만 인증서와 사용가능
- 개인키를 여러 번 생성 시, 신청 당시 기입한 최종 CSR과 매칭되는 개인키만 사용 가능

#### 1개의 서버에 여러 도메인(인증서) 사용시 주의사항
- https(SSL)을 사용하는 포트는 설치한 인증서 수량과 같아야 함
- 2개의 인증서를 설치 시 2개의 각각 다른 포트가 필요함
- 와일드카드 SSL인증서 (`*.example.com`), 멀티도메인 SSL인증서는 동일한 포트 공유가 가능한 SSL 인증서
- 멀티도메인 인증서 설치 후 인증서에 도메인을 추가 신청 시 인증서는 재설치 해야 함

#### https 사용 포트를 "443"이 아닌 다른 포트를 지정하면 URL 입력 시 포트까지 입력
- 예시1) `https://www.example.com:443` - "443"포트는 기본 SSL 포트이므로 생략이 가능
- 예시2) `https://www.example.com:442` - "442"포트로 SSL 포트 설정 시 URL에 포트번호 필수 기입

### 4.2 자주 발생하는 오류

#### 오류 1: Pass phrase incorrect (패스워드 오류)

**에러 메시지:**
```
[error] Init: Pass phrase incorrect
[error] SSL Library Error: 218529960 error:0D0680A8:asn1 encoding routines:ASN1_CHECK_TLEN:wrong tag
[error] SSL Library Error: 218640442 error:0D08303A:asn1 encoding routines:ASN1_TEMPLATE_NOEXP_D2I:nested asn1 error
```

**원인:** 패스워드를 자동 입력하여 서버를 시작하는 환경에서, 패스워드를 잘못 적은 경우 발생

**해결방법:** 패스워드 입력 부분을 확인하여 문자로 안내받은 패스워드 입력 (문자로 패스워드 수신 못하셨을 경우, KICASSL로 도메인 기재하여 문의)

#### 오류 2: 안드로이드 v.5.0(롤리팝)+ 또는 구글 크롬 브라우저에서 https 접속 안될 시

**원인:** SSL인증서가 아닌 TLS 프로토콜 확인

**해결방법:** 웹 서버에 SSL Protocol 중 TLS v1.2를 사용 가능하도록 수정하고 해당 웹 서버의 최신 보안패치 설치 (브라우저사 정책 변경으로 인하여 TLS v1.2이상 사용이 권고되어 해당 프로토콜 미지원 시 접속 안될 수 있음)

#### 오류 3: https 접속 시 딜레이가 길거나, "인증서 해지 목록을 확인 할 수 없습니다." 표시

**원인:** 사용자의 환경이 공용망이 아닌 경우, 외부 CRL 및 OCSP URL로 접속이 제한되어 있다면 브라우저가 SSL 인증서 관련 정보 탐색을 하지 못하여 발생

**해결방법:** 방화벽 등 네트워크 장비에서 관련 접속 URL(또는 IP) 및 port를 open 하여 사용자가 원활히 접속하여 사용 할 수 있도록 작업 필요 (CRL, OCSP URL 정보는 인증서마다 다르므로 인증서 파일 상세 정보에서 "자세히" 탭 내용 중 "CRL 배포 지점", "기관 정보 액세스"에 기입된 URL을 확인)

#### 오류 4: https접속 시 설치한 SSL 인증서가 아닌 다른 SSL 인증서가 로드 되는 오류

**원인:** 설치하신 웹서버로 직접 접속하여 어떤 인증서를 로드 했는지 확인 필요

**해결방법:**
1. 웹 서버 IP주소로 `https://아이피:포트`로 접속 후 표시되는 인증서 오류 화면에서 "계속 탐색" 클릭
2. 웹브라우저에 로드된 SSL 인증서 정보를 확인
3. 설치된 인증서가 표시된다면 L4, 방화벽 또는 웹 서버 앞 단에 장비에도 SSL 인증서 설치가 필요한지 확인 필요

#### 오류 5: "유효하지 않은 인증서" 표시

**1) 폐쇄망 등 특정 환경의 사용자만 발생할 시**
- 원인: 중개인증서가 웹 서버에 설치의 문제가 있어서 사용자(접속자)에게 중개인증서를 전달해주지 못 할 때 발생할 수 있음
- 해결방법: 중개인증서 본 가이드의 설치 부분을 확인해 주시길 바랍니다

**2) WIN XP, IE 8이하 등 낮은 버전 환경 또는 윈도우 업데이트를 하지 않은 사용자**
- 원인: 사용자(접속자)의 환경에 루트인증서가 존재하지 않아 발생할 수 있음
- 해결방법: 윈도우에 내장된 윈도우 업데이트를 통해 윈도우 업데이트를 하거나, 첨부한 RootCA.crt 파일을 직접 사용자PC에 수동 설치해야 함

#### 오류 6: "만료된 인증서" 표시

**해결방법:**
1. 해당 도메인의 접속한 사용자 PC의 시간이 현재 시간인지 확인해주시길 바랍니다
2. 해당 도메인에 설치된 인증서 정보창을 띄워 해당 인증서의 만료일을 확인해주시기 바랍니다

> 도메인 인증서 갱신을 했는데도 발생한 경우, 방화벽 또는 L4 등 다른 장비에 인증서 설치가 필요한지 확인해주시길 바랍니다

#### 오류 7: "폐기된 인증서" 표시

**해결방법:** 인증서가 폐기 또는 해지된 경우 KICASSL에 발급받으신 인증서 도메인명 기재하여 문의 해주시길 바랍니다

---

## FAQ

### Q) 복호화된 개인키 파일이 무엇인가요?
**A)** 패스워드가 없는 개인키 파일 형식 입니다. NginX의 경우, 패스워드가 제거된 인증서 형태로 설치하는 것을 권장합니다.

### Q) 복호화 키파일을 받았는데 왜 문자로 패스워드 안내가 오나요?
**A)** 추후에 NginX외 다른 서버로 인증서 변환 요청 시, 필요한 정보로 패스워드 정보를 문자발송해드리고 있습니다. 패스워드 정보 분실 시, 재발급 진행을 해야 될 수 있습니다.

### Q) 기존에 crt 확장자로 적용하였는데 어떻게 해야되나요?
**A)** NginX는 pem, crt 확장자 모두 설치 가능합니다. crt 확장자로 설치를 원하실 경우, 오른쪽 마우스 클릭 - [이름바꾸기] 로 확장자 변경하여 설치 진행해주시면 됩니다.

### Q) 서버 재기동 꼭 해야되나요?
**A)** 인증서파일과 설정파일을 변경하는 작업이므로 재기동이 필요 합니다.

### Q) 서버/로컬에서는 발급받은 인증서의 유효기간이 확인되는데, 브라우저에서 확인할 때는 이전 인증서 정보가 보여요.
**A)** 웹서버 외 앞 단의 방화벽 또는 장비가 있는 경우, 방화벽/장치 모두 인증서 교체를 진행해주셔야 됩니다.

### Q) 서버에 443포트로 Listen 했는데, https://도메인 으로 접속되지 않아요.
**A)** 웹방화벽/장치의 설정포트 오픈 여부 확인해주시기 바랍니다.

---

## 문의처

- 웹사이트: www.kicassl.com
- 대표전화: 02-360-3065
- 이메일: webmaster@kicassl.com
